{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do List</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- App CSS -->
         <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
</head>
<body>

<div class="app-container">

    <!-- HEADER -->
    <header class="app-header">
        <div class="header-left">
            <h1>To-Do List App</h1>
            <p class="subtle">A new way of managing your tasks efficiently.</p>
        </div>

        <!-- AUTH NAVIGATION ADDED HERE -->
        <nav class="header-nav">
            {% if request.session.user_id %}
                <a class="nav-btn" href="/auth/logout/">Logout</a>
            {% else %}
                <a class="nav-btn" href="/auth/login/">Sign In</a>
                <a class="nav-btn" href="/auth/signup/">Sign Up</a>
            {% endif %}
        </nav>
    </header>

    <!-- FILTER NAVIGATION -->
    <nav class="header-nav" style="margin-top:10px;">
        <button class="nav-btn active" onclick="filterTasks('all', this)">All</button>
        <button class="nav-btn" onclick="filterTasks('pending', this)">To-Do</button>
        <button class="nav-btn" onclick="filterTasks('completed', this)">Completed</button>
        <button class="nav-btn" onclick="filterTasks('archived', this)">Archived</button>
        <button class="nav-btn" onclick="filterTasks('bin', this)">Bin üóëÔ∏è</button>
    </nav>

    <!-- DASHBOARD -->
    <section class="mini-dashboard">
        <div class="stat">
            <div class="stat-title">Total</div>
            <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="stat">
            <div class="stat-title">Completed</div>
            <div class="stat-value" id="stat-completed">0</div>
        </div>
        <div class="stat">
            <div class="stat-title">Pending</div>
            <div class="stat-value" id="stat-pending">0</div>
        </div>
        <div class="stat">
            <div class="stat-title">Archived</div>
            <div class="stat-value" id="stat-archived">0</div>
        </div>
    </section>

    <!-- SEARCH + SORT -->
    <section class="top-controls">
        <input id="search-bar" placeholder="üîç Search tasks..." oninput="searchTasks(this.value)">
        <select id="sort-order" onchange="sortTasks(this.value)">
            <option value="newest">Sort by Newest</option>
            <option value="upcoming">Sort by Upcoming</option>
            <option value="oldest">Sort by Oldest</option>
        </select>
    </section>

    <!-- ADD TASK -->
    <section class="add-task">
        <form id="todo-form">
            <input id="title" type="text" placeholder="Task title..." required>
            <textarea id="description" placeholder="Task description (optional)..."></textarea>

            <div class="form-row">
                <input id="due-date" type="date">
                <select id="priority">
                    <option value="Low">Low Priority</option>
                    <option value="Medium">Medium Priority</option>
                    <option value="High">High Priority</option>
                </select>
            </div>

            <button type="submit" class="primary-btn">+ Add Task</button>
        </form>
    </section>

    <!-- OVERALL PROGRESS -->
    <section class="progress-section">
        <div class="progress-header">
            <h3>Overall Progress</h3>
            <p id="progress-text">0% Completed</p>
        </div>

        <div class="progress-bar">
            <div id="progress-fill"></div>
        </div>
    </section>

    <!-- TASK LIST -->
    <main id="task-section">
        <ul id="todo-list"></ul>
    </main>

</div>

<!-- YOUR JS CODE UNCHANGED BELOW -->
<script>
const API_URL = "/api/todos/";

let allTasks = [];
let currentFilter = "all";
let searchQuery = "";
let sortOrder = "newest";

async function loadTodos() {
    const res = await fetch(API_URL);
    allTasks = await res.json();
    renderTasks();
}

function formatDate(dateString) {
    if (!dateString) return "No due date";
    const d = new Date(dateString);
    return isNaN(d) ? dateString : d.toLocaleDateString();
}

function renderTasks() {
    const list = document.getElementById("todo-list");

    let filtered = allTasks.filter(todo => {
        if (currentFilter === "all") return !todo.archived && !todo.deleted;
        if (currentFilter === "pending") return !todo.completed && !todo.archived && !todo.deleted;
        if (currentFilter === "completed") return todo.completed && !todo.archived && !todo.deleted;
        if (currentFilter === "archived") return todo.archived && !todo.deleted;
        if (currentFilter === "bin") return todo.deleted;
    });

    if (searchQuery) {
        const q = searchQuery.toLowerCase();
        filtered = filtered.filter(t =>
            (t.title && t.title.toLowerCase().includes(q)) ||
            (t.description && t.description.toLowerCase().includes(q))
        );
    }

    list.innerHTML = "";

    if (!filtered.length) {
        list.innerHTML = `<p class="empty-state">No tasks to show here.</p>`;
        updateDashboard(filtered);
        return;
    }

    filtered.forEach(todo => {
        const li = document.createElement("li");

        const color = todo.deleted ? "deleted" :
                      todo.archived ? "archived" :
                      todo.completed ? "completed" : "todo";

        li.className = `task-card ${color}`;

        li.innerHTML = `
            <div class="task-header">
                <h3>${todo.title}</h3>
                <span>${todo.progress}%</span>
            </div>

            <p>${todo.description || ""}</p>

            <div class="task-meta">
                <span>üìÖ ${formatDate(todo.due_date)}</span> |
                <span>üî• ${todo.priority}</span>
            </div>

            <div class="task-progress">
                <div class="progress-inner" style="width:${todo.progress}%"></div>
            </div>

            ${!todo.deleted ? `
                <input type="range" min="0" max="100" value="${todo.progress}"
                    class="progress-slider" onchange="updateTaskProgress('${todo.id}', this.value)">
            ` : ""}

            <div class="task-actions">
                ${!todo.deleted ? `
                    <button onclick="toggleComplete('${todo.id}', ${todo.completed})">
                        ${todo.completed ? "‚Ü∫ Undo" : "‚úî Complete"}
                    </button>

                    <button onclick="toggleArchive('${todo.id}', ${todo.archived})">
                        ${todo.archived ? "Unarchive" : "Archive"}
                    </button>

                    <button onclick="moveToBin('${todo.id}')">üóë Move to Bin</button>
                ` : `
                    <button onclick="restore('${todo.id}')">‚ôª Restore</button>
                    <button onclick="deletePermanently('${todo.id}')">‚ùå Delete Permanently</button>
                `}
            </div>
        `;

        list.appendChild(li);
    });

    updateDashboard(filtered);
}

function updateDashboard(tasks) {
    const total = allTasks.filter(t => !t.deleted).length;
    const completed = allTasks.filter(t => t.completed && !t.deleted).length;
    const pending = allTasks.filter(t => !t.completed && !t.deleted && !t.archived).length;
    const archived = allTasks.filter(t => t.archived && !t.deleted).length;

    document.getElementById("stat-total").textContent = total;
    document.getElementById("stat-completed").textContent = completed;
    document.getElementById("stat-pending").textContent = pending;
    document.getElementById("stat-archived").textContent = archived;

    const avg = tasks.length
        ? Math.round(tasks.reduce((a, b) => a + (b.progress || 0), 0) / tasks.length)
        : 0;

    document.getElementById("progress-text").textContent = `${avg}% Completed`;
    document.getElementById("progress-fill").style.width = avg + "%";
}

document.getElementById("todo-form").addEventListener("submit", async e => {
    e.preventDefault();

    const data = {
        title: document.getElementById("title").value,
        description: document.getElementById("description").value,
        due_date: document.getElementById("due-date").value,
        priority: document.getElementById("priority").value,
        progress: 0,
        deleted: false,
        archived: false,
        completed: false
    };

    await fetch(API_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    });

    e.target.reset();
    loadTodos();
});

async function patch(id, data) {
    await fetch(`${API_URL}${id}/`, {
        method: "PATCH",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    });
}

async function toggleComplete(id, current) {
    await patch(id, {completed: !current});
    loadTodos();
}

async function toggleArchive(id, current) {
    await patch(id, {archived: !current});
    loadTodos();
}

async function moveToBin(id) {
    await patch(id, {deleted: true});
    loadTodos();
}

async function restore(id) {
    await patch(id, {deleted: false});
    loadTodos();
}

async function deletePermanently(id) {
    await fetch(`${API_URL}${id}/`, {method: "DELETE"});
    loadTodos();
}

async function updateTaskProgress(id, value) {
    await patch(id, {progress: Number(value)});
    loadTodos();
}

function searchTasks(query) {
    searchQuery = query;
    renderTasks();
}

function filterTasks(type, btn) {
    currentFilter = type;
    document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    renderTasks();
}

function sortTasks(order) {
    sortOrder = order;
    renderTasks();
}

loadTodos();
</script>

</body>
</html>
