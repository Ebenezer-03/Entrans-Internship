{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>To-Do â€” Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
  <div class="app-shell">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <h2>To-Do</h2>
        <p class="muted">Productive â€¢ Minimal</p>
      </div>

      <nav class="sidebar-nav">
        <button class="sb-btn active" data-filter="all">All Tasks</button>
        <button class="sb-btn" data-filter="pending">To-Do</button>
        <button class="sb-btn" data-filter="completed">Completed</button>
        <button class="sb-btn" data-filter="archived">Archived</button>
      </nav>

      <div class="sidebar-footer">
        {% if request.session.user_email %}
          <div class="user">
            <div class="avatar">{{ request.session.user_email|slice:":1"|upper }}</div>
            <div class="user-info">
              <div class="user-email">{{ request.session.user_email }}</div>
              <a href="/auth/logout/" class="logout-link">Logout</a>
            </div>
          </div>
        {% else %}
          <div class="auth-links">
            <a href="/auth/login/" class="link">Sign in</a>
            <a href="/auth/signup/" class="link">Sign up</a>
          </div>
        {% endif %}
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">

      <!-- HEADER / STATS -->
      <header class="main-header">
        <div>
          <h1 class="title">To-Do List App</h1>
          <p class="subtle">A new way of managing your tasks efficiently.</p>
        </div>

        <div class="header-widgets">
          <div class="stats-row">
            <div class="stat">
              <div class="stat-value" id="stat-total">0</div>
              <div class="stat-title">Total</div>
            </div>
            <div class="stat">
              <div class="stat-value" id="stat-completed">0</div>
              <div class="stat-title">Completed</div>
            </div>
            <div class="stat">
              <div class="stat-value" id="stat-pending">0</div>
              <div class="stat-title">Pending</div>
            </div>
            <div class="stat">
              <div class="stat-value" id="stat-archived">0</div>
              <div class="stat-title">Archived</div>
            </div>
          </div>

          <!-- Donut -->
          <div class="donut-wrap">
            <canvas id="donut" width="120" height="120"></canvas>
            <div class="donut-center">
              <span id="donut-total">0</span>
              <small>Total</small>
            </div>
          </div>
        </div>
      </header>

      <!-- CONTROLS -->
      <section class="controls">
        <input id="search-bar" placeholder="ðŸ” Search tasks..." />
        <select id="sort-order">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
          <option value="upcoming">Upcoming</option>
        </select>
      </section>

      <!-- ADD TASK -->
      <section class="add-task">
        <form id="todo-form" class="glass-form">
          <input id="title" type="text" placeholder="Task title..." required>
          <textarea id="description" placeholder="Task description (optional)..."></textarea>

          <div class="row">
            <input id="due-date" type="date">
            <select id="priority">
              <option value="Low">Low Priority</option>
              <option value="Medium">Medium Priority</option>
              <option value="High">High Priority</option>
            </select>
            <button type="submit" class="primary-btn">+ Add Task</button>
          </div>
        </form>
      </section>

      <!-- OVERALL PROGRESS -->
      <section class="progress-section">
        <div class="progress-header">
          <h3>Overall Progress</h3>
          <p id="progress-text">0% Completed</p>
        </div>
        <div class="progress-bar"><div id="progress-fill"></div></div>
      </section>

      <!-- TASK LIST -->
      <section id="task-list" class="task-list"></section>

    </main>
  </div>

  <!-- CONFIRM MODAL -->
  <div id="confirm-modal" class="modal hidden">
    <div class="modal-card">
      <h3>Confirm Permanent Delete</h3>
      <p>This action cannot be undone.</p>
      <div class="modal-actions">
        <button id="confirm-cancel" class="btn-muted">Cancel</button>
        <button id="confirm-ok" class="btn-danger">Delete Permanently</button>
      </div>
    </div>
  </div>

<!-- SCRIPT -->
<script>
const API_URL = "/api/todos/";
let allTasks = [];
let currentFilter = "all";
let searchQuery = "";
let sortOrder = "newest";

function qs(s){return document.querySelector(s)}
function qsa(s){return [...document.querySelectorAll(s)]}

function formatDate(v){
  if(!v) return "No due date";
  const d = new Date(v);
  return isNaN(d) ? v : d.toLocaleDateString();
}

async function loadTodos(){
  try {
    const r = await fetch(API_URL);
    allTasks = await r.json();
  } catch {
    allTasks = [];
  }
  renderTasks();
  drawDonutAnimated();
}

function renderTasks(){
  const box = qs("#task-list");
  let list = allTasks.filter(t=>!t.deleted);

  if (currentFilter==="pending") list = list.filter(t=>!t.completed && !t.archived);
  if (currentFilter==="completed") list = list.filter(t=>t.completed);
  if (currentFilter==="archived") list = list.filter(t=>t.archived);

  if (searchQuery){
    const q = searchQuery.toLowerCase();
    list = list.filter(t=>t.title.toLowerCase().includes(q));
  }

  if (sortOrder==="oldest") list.reverse();

  box.innerHTML = "";

  if (!list.length){
    box.innerHTML = `<div class="empty">No tasks here.</div>`;
    return;
  }

  list.forEach(todo=>{
    const id = todo.id || todo._id;

    const el = document.createElement("article");
    el.className = "task-card";

    el.innerHTML = `
      <div class="task-head">
        <canvas class="mini-can" width="48" height="48" data-id="${id}"></canvas>

        <div class="task-title-wrap">
          <h4 class="task-title">${todo.title}</h4>
          <div class="task-meta">
            <span class="muted small">${todo.description || ""}</span>
            <div class="meta-row">
              <small>ðŸ“… ${formatDate(todo.due_date)}</small>
              <small> â€¢ ðŸ”¥ ${todo.priority}</small>
            </div>
          </div>
        </div>

        <div class="task-pct">${todo.progress}%</div>
      </div>

      <div class="task-progress">
        <div class="progress-inner" style="width:${todo.progress}%"></div>
      </div>

      <!-- â­ NEW SLIDER -->
      <input type="range" class="progress-slider"
             min="0" max="100"
             value="${todo.progress}"
             oninput="updateTaskProgress('${id}', this.value)">

      <div class="task-actions">
        <button class="btn" data-act="toggle" data-id="${id}" data-val="${todo.completed}">
          ${todo.completed ? "â†º Undo" : "âœ” Complete"}
        </button>
        <button class="btn" data-act="archive" data-id="${id}" data-val="${todo.archived}">
          ${todo.archived ? "Unarchive" : "Archive"}
        </button>
        <button class="btn danger" data-act="bin" data-id="${id}">ðŸ—‘ Bin</button>
      </div>
    `;

    box.appendChild(el);

    drawMiniDonut(el.querySelector(".mini-can"), todo.progress);
  });

  updateDashboard();
}

function updateDashboard(){
  const total = allTasks.filter(t=>!t.deleted).length;
  const completed = allTasks.filter(t=>t.completed).length;
  const pending = allTasks.filter(t=>!t.completed && !t.archived).length;
  const archived = allTasks.filter(t=>t.archived).length;

  qs("#stat-total").textContent = total;
  qs("#stat-completed").textContent = completed;
  qs("#stat-pending").textContent = pending;
  qs("#stat-archived").textContent = archived;

  qs("#donut-total").textContent = total;

  const visible = allTasks.filter(t=>!t.deleted);
  const avg = visible.length
    ? Math.round(visible.reduce((a,b)=>a+(b.progress||0),0) / visible.length)
    : 0;

  qs("#progress-text").textContent = `${avg}% Completed`;
  qs("#progress-fill").style.width = avg + "%";
}

/* -----------------------------
   â­ NEW: Instant Progress Update
----------------------------- */
async function updateTaskProgress(id, value){
  const pct = Number(value);

  const t = allTasks.find(x => x.id==id || x._id==id);
  if (t) t.progress = pct;

  const card = document.querySelector(`input[data-id]`);

  const element = document.querySelector(
    `canvas[data-id="${id}"]`
  )?.closest(".task-card");

  if (element){
    element.querySelector(".progress-inner").style.width = pct + "%";
    element.querySelector(".task-pct").textContent = pct + "%";
    drawMiniDonut(element.querySelector(".mini-can"), pct);
  }

  apiPatch(id, { progress: pct });
}

/* ---- Donut functions unchanged ---- */
function drawMiniDonut(canvas, pct){
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;
  const cx=w/2, cy=h/2, r=18;

  ctx.clearRect(0,0,w,h);

  ctx.beginPath();
  ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.lineWidth=6;
  ctx.strokeStyle="#eef2ff";
  ctx.stroke();

  ctx.beginPath();
  ctx.arc(cx,cy,r,-Math.PI/2, -Math.PI/2 + (pct/100)*Math.PI*2);
  ctx.lineWidth=6;
  ctx.lineCap="round";
  ctx.strokeStyle = pct>=80 ? "#16a34a" : pct>=40 ? "#2563eb" : "#f59e0b";
  ctx.stroke();

  ctx.font="10px Inter";
  ctx.fillStyle="#374151";
  ctx.textAlign="center";
  ctx.textBaseline="middle";
  ctx.fillText(pct+"%", cx, cy);
}

/* Actions */
qs("#task-list").addEventListener("click", async ev=>{
  const btn = ev.target.closest("button");
  if(!btn) return;

  const id = btn.dataset.id;
  const act = btn.dataset.act;
  const cur = btn.dataset.val === "true";

  if(act==="toggle") await apiPatch(id,{completed:!cur});
  if(act==="archive") await apiPatch(id,{archived:!cur});
  if(act==="bin") await apiPatch(id,{deleted:true});

  loadTodos();
});

async function apiPatch(id,data){
  await fetch(`${API_URL}${id}/`, {
    method:"PATCH",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data)
  });
}

async function apiPost(d){
  await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(d)
  });
}

/* Init */
loadTodos();

</script>
</body>
</html>
